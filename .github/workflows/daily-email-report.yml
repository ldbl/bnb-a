name: 📧 Daily BNB Analysis Email Report

on:
  schedule:
    # Run daily at 8:00 AM UTC (10:00 AM Bulgaria time)
    - cron: '0 8 * * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (generate report but don\'t send email)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  send-daily-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
    
    - name: 🐍 Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: 📦 Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: 🧪 Test mode - Generate report only
      if: github.event.inputs.test_mode == 'true'
      env:
        TEST_MODE: 'true'
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
      run: |
        echo "🧪 Running in test mode - generating report without sending email"
        python email_reporter.py
    
    - name: 📧 Send daily email report
      if: github.event.inputs.test_mode != 'true'
      env:
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
        SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
      run: |
        echo "📧 Sending daily BNB analysis report..."
        python email_reporter.py
    
    - name: ✅ Report completion
      if: success()
      run: |
        echo "✅ Daily email report workflow completed successfully!"
        echo "📊 BNB analysis sent to recipient"
    
    - name: ❌ Report failure
      if: failure()
      run: |
        echo "❌ Daily email report workflow failed!"
        echo "🔧 Check logs for troubleshooting"
